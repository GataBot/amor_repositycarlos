<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Una Sorpresa Para Ti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* ---- Estilos Generales ---- */
        html { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #0c0012;
            margin: 0;
            height: 100%;
            perspective: 1000px;
            cursor: default;
            user-select: none;
        }
        .main-container {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center;
        }
        .dancing-script { font-family: 'Dancing Script', cursive; }
        
        /* ---- Animación del fondo estrellado ---- */
        #star-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle linear infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        /* ---- Estrellas Fugaces ---- */
        .shooting-star {
            position: absolute;
            height: 2px;
            background: linear-gradient(-45deg, #fff, rgba(255, 255, 255, 0));
            border-radius: 999px;
            filter: drop-shadow(0 0 6px #fff);
            animation: tail 3s ease-in-out infinite, shooting 3s ease-in-out infinite;
        }
        @keyframes tail {
            0% { width: 0; }
            30% { width: 100px; }
            100% { width: 0; }
        }
        @keyframes shooting {
            0% { transform: translateX(0); }
            100% { transform: translateX(500px); }
        }

        /* ---- Efecto Aurora Boreal ---- */
        #aurora-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.4;
            mix-blend-mode: screen;
        }
        .aurora {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            filter: blur(80px);
            animation: drift 20s infinite linear alternate;
        }
        .aurora:nth-child(1) { background: radial-gradient(circle, #8a2be2, transparent 60%); top: 10%; left: 15%; }
        .aurora:nth-child(2) { background: radial-gradient(circle, #c3aed6, transparent 60%); top: 40%; left: 45%; animation-duration: 25s; }
        .aurora:nth-child(3) { background: radial-gradient(circle, #4a046e, transparent 60%); top: 20%; left: 70%; animation-duration: 18s; }
        @keyframes drift {
            from { transform: rotate(0deg) translateX(50px) scale(1.2); }
            to { transform: rotate(360deg) translateX(50px) scale(1.5); }
        }
        
        /* ---- Rastro del cursor y TÁCTIL ---- */
        .cursor-trail {
            position: fixed;
            width: 8px; height: 8px;
            background: linear-gradient(45deg, #ffd700, #fffae0);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10001;
            transform: translate(-50%, -50%);
            animation: trail-fade 0.8s forwards ease-out;
            box-shadow: 0 0 8px #ffd700, 0 0 12px #fff;
        }
        @keyframes trail-fade {
            to { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }

        /* ---- Preloader y Mensaje de Bienvenida ---- */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0c0012; display: flex; justify-content: center; align-items: center; z-index: 10000; flex-direction: column; transition: opacity 0.8s ease; }
        #welcome-message {
            color: #e0b0ff;
            font-size: 2.5rem;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            text-shadow: 0 0 10px #e0b0ff;
        }
        #welcome-message.visible { opacity: 1; }
        .heart-loader { width: 50px; height: 50px; background: #d8bfd8; position: relative; transform: rotate(45deg); animation: beat 1s infinite; }
        .heart-loader:before, .heart-loader:after { content: ""; position: absolute; width: 50px; height: 50px; border-radius: 50%; background: #d8bfd8; }
        .heart-loader:before { top: -25px; left: 0; }
        .heart-loader:after { top: 0; left: -25px; }
        @keyframes beat { 0%, 100% { transform: rotate(45deg) scale(1); } 50% { transform: rotate(45deg) scale(1.1); } }

        /* ---- Sobre ---- */
        .envelope-wrapper { transition: transform 1s ease-in-out, opacity 0.5s 2s ease; opacity: 0; transform: scale(0.9); }
        .envelope-wrapper.loaded { opacity: 1; }
        .envelope { position: relative; width: 300px; height: 200px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: all 1s ease-in-out; transform-style: preserve-3d; background-color: #e9d8e9; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d8bfd8' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        .envelope-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px; z-index: 1; }
        .flap { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #c3aed6; clip-path: polygon(0 0, 100% 0, 50% 55%); transform-origin: top; transition: transform 1s ease-in-out; z-index: 3; transform: rotateX(0deg); }
        .wax-seal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background-color: #b19cd9; border-radius: 50%; z-index: 4; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.3), inset -2px -2px 4px rgba(0,0,0,0.2); animation: pulse-seal 2s infinite; }
        .wax-seal svg { width: 60%; height: 60%; fill: #9370db; }
        @keyframes pulse-seal { 0% { box-shadow: 2px 2px 5px rgba(0,0,0,0.3), 0 0 0 0 rgba(177, 156, 217, 0.7); } 70% { box-shadow: 2px 2px 5px rgba(0,0,0,0.3), 0 0 0 10px rgba(177, 156, 217, 0); } 100% { box-shadow: 2px 2px 5px rgba(0,0,0,0.3), 0 0 0 0 rgba(177, 156, 217, 0); } }
        .open .flap { transform: rotateX(180deg); transition-delay: 0.2s; }
        .open .envelope-wrapper { transform: translateY(110vh) rotateZ(15deg) scale(0.5); opacity: 0; }
        .open .wax-seal { opacity: 0; transition: opacity 0.2s; }
        
        /* ---- Página de la Carta (Adaptable) ---- */
        .full-page-letter { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: center; align-items: center; transform: scale(0); opacity: 0; transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease; transition-delay: 1.8s; padding: 2vh; }
        .open .full-page-letter { transform: scale(1); opacity: 1; }
        .paper-sheet { background: #ffffff; width: 100%; max-width: 800px; height: 95%; max-height: 90vh; border-radius: 10px; padding: 20px; overflow-y: auto; text-align: center; position: relative; animation: neon-glow 2.5s infinite alternate; }
        @keyframes neon-glow { from { box-shadow: 0 0 10px #d8bfd8, 0 0 20px #d8bfd8, 0 0 30px #c3aed6, 0 0 40px #8a2be2; } to { box-shadow: 0 0 5px #d8bfd8, 0 0 10px #d8bfd8, 0 0 15px #c3aed6, 0 0 20px #8a2be2; } }
        #love-letter-text { font-family: 'Inter', sans-serif; font-size: 1rem; line-height: 1.6rem; color: #333; }
        #love-letter-text p { opacity: 0; }
        .reveal-text { opacity: 0; transform: translateY(20px); animation: reveal 1s ease-out forwards; }
        @keyframes reveal { to { opacity: 1; transform: translateY(0); } }

        /* ---- Botones Sí/No ---- */
        .declaration { margin-top: 20px; padding-top: 20px; border-top: 1px dashed #d8bfd8; }
        .buttons { margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 1rem; position: relative; min-height: 50px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; border: none; }
        .btn-yes { background-color: #8a2be2; z-index: 10; transition: all 0.3s ease; }
        .btn-yes:hover { background-color: #9932cc; transform: scale(1.05); }
        .btn-no { background-color: #c3aed6; transition: top 0.4s ease-out, left 0.4s ease-out, transform 0.4s ease; }
        
        .btn-no.evading {
            animation: frantic-shake 0.4s ease-in-out;
        }

        @keyframes frantic-shake {
            0%, 100% { transform: translateX(0) rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) rotate(-3deg); }
            20%, 40%, 60%, 80% { transform: translateX(5px) rotate(3deg); }
        }
        
        /* ---- Carrusel de Fotos 3D ---- */
        #photoCarousel {
            opacity: 0;
            transition: opacity 1s ease 1s;
            margin: 20px auto 0 auto;
            width: 95%;
            max-width: 500px;
        }
        .carousel-wrapper-3d {
            perspective: 1000px;
            position: relative;
            width: 100%;
            height: 300px;
            margin: 30px 0;
        }
        .carousel-container-3d {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 1s ease-in-out;
        }
        .carousel-slide-3d {
            position: absolute;
            width: 70%;
            height: 100%;
            left: 15%;
            top: 0;
            border-radius: 15px;
            overflow: hidden;
            backface-visibility: hidden;
            border: 3px solid #d8bfd8;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            background-color: rgba(0,0,0,0.2);
        }
        .carousel-slide-3d img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* CAMBIO: Para mostrar la imagen completa */
            display: block;
        }
        .carousel-nav-3d {
            text-align: center;
            margin-top: 10px;
        }
         .carousel-nav-3d button {
            background-color: rgba(138, 43, 226, 0.6);
            border: none;
            color: white;
            padding: 10px 15px;
            margin: 0 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 45px;
            height: 45px;
        }
        .carousel-nav-3d button:hover {
            background-color: rgba(138, 43, 226, 0.9);
        }

        /* ---- Constelación y Mapa Estelar Interactivo ---- */
        .interactive-starmap-card {
            background: rgba(23, 11, 34, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 40px auto 0 auto;
            width: 95%;
            max-width: 500px;
            text-align: center;
            opacity: 0;
            animation: reveal 1s 1.5s ease-out forwards;
        }
        .starmap-container {
            position: relative;
            width: 100%;
            height: 200px;
        }
        .starmap-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .starmap-message {
            margin-top: 15px;
            color: #ffd700;
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            min-height: 2.5rem;
            text-shadow: 0 0 10px #ffd700;
            transition: opacity 0.3s ease;
        }

        /* ---- Estrella Secreta Final ---- */
        #secret-star-card {
            margin: 20px auto 0 auto;
            cursor: pointer;
            width: 95%;
            max-width: 500px;
        }
        #secret-star-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px;
            background: rgba(23, 11, 34, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
        }
        #secret-star { width: 12px; height: 12px; background: #ffd700; border-radius: 50%; box-shadow: 0 0 15px #ffd700, 0 0 25px #ffd700; animation: pulse-secret-star 2s infinite; }
        @keyframes pulse-secret-star { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        #secret-star-container span { color: #ffd700; font-family: 'Dancing Script'; font-size: 1.2rem; }
        
        /* ---- Efectos Adicionales ---- */
        #click-particles, #confetti-container { position: fixed; inset: 0; pointer-events: none; z-index: 9998; }
        .click-particle { position: absolute; background-color: var(--color); border-radius: 50%; animation: pop-particle 0.6s ease-out forwards; }
        @keyframes pop-particle { from { transform: translate(0, 0) scale(1); opacity: 1; } to { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; } }
        #bouquet { position: fixed; left: 50%; bottom: 0; width: 300px; height: 400px; transform: translateX(-50%) translateY(100%); opacity: 0; transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.8s ease; z-index: 200; pointer-events: none; }
        #bouquet.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #bouquet.hide { opacity: 0; transform: translateX(-50%) translateY(100%); transition: all 1s ease-in 0.5s; }
        .flower-wrap { position: absolute; bottom: 0; left: 50%; }
        #flower1 { transform: translateX(-50%) rotate(-20deg) scale(0.9); }
        #flower2 { transform: translateX(-50%) rotate(5deg) scale(1); z-index: 10; bottom: 10px; }
        #flower3 { transform: translateX(-50%) rotate(25deg) scale(0.85); }
        .stem { width: 8px; height: 250px; background: linear-gradient(to top, #38761d, #6aa84f); border-radius: 4px; transform-origin: bottom; transform: scaleY(0); }
        .flower-head { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; }
        .petal { position: absolute; left: 50%; top: 50%; transform-origin: bottom center; transform: translate(-50%, -50%) rotate(var(--r, 0deg)) translateY(-20px) scale(0); width: 40px; height: 50px; background: radial-gradient(circle at 50% 100%, #e0b0ff, #a46ed6); border-radius: 50% 50% 0 0; opacity: 0; }
        #bouquet.show .stem { animation: grow-stem 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes grow-stem { from { transform: scaleY(0); } to { transform: scaleY(1); } }
        #bouquet.show .petal { animation: bloom-petal 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; animation-delay: calc(0.8s + var(--d)); }
        @keyframes bloom-petal { 0% { transform: translate(-50%, -50%) rotate(var(--r, 0deg)) translateY(-20px) scale(0); opacity: 0; } 100% { transform: translate(-50%, -50%) rotate(var(--r, 0deg)) translateY(-20px) scale(1); opacity: 1; } }
        .flower-center { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; background: radial-gradient(circle, #ffee58, #f5d400); border-radius: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; }
        #bouquet.show .flower-center { animation: bloom-center 0.6s ease forwards 1.5s; }
        @keyframes bloom-center { from { transform: translate(-50%, -50%) scale(0); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        #finalMessage, #concludingMessage { opacity: 0; transition: opacity 1.5s ease; }
        #concludingMessage { transition-delay: 1s; }
        .confetti-piece { position: absolute; width: 10px; height: 20px; opacity: 0; animation: fall 5s linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        #hearts-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
        .heart { position: absolute; width: 20px; height: 20px; opacity: 0; animation: float-heart 8s linear forwards; }
        .heart::before, .heart::after { content: ''; position: absolute; width: 20px; height: 20px; background: #e0b0ff; border-radius: 50%; }
        .heart::before { top: -10px; left: 0; }
        .heart::after { top: 0; left: -10px; }
        @keyframes float-heart { 0% { transform: translateY(100%) rotate(45deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(45deg); opacity: 0; } }
        #mute-btn { position: fixed; bottom: 20px; right: 20px; background-color: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 1001; opacity: 0; transition: opacity 0.5s ease; }
        #mute-btn.visible { opacity: 1; }

        /* ---- Estilos para Corazón Final ---- */
        #final-heart-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 10002; display: flex; flex-direction:column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        #final-heart-modal.visible { opacity: 1; pointer-events: all; }
        #final-heart-svg { width: 250px; height: 250px; }
        #final-heart-path { stroke: #ff79c6; stroke-width: 3; fill: transparent; stroke-dasharray: 1000; stroke-dashoffset: 1000; }
        #final-heart-text { color: white; opacity: 0; margin-top: 1rem; font-size: 1.5rem; text-shadow: 0 0 10px #ff79c6;}
        
        @keyframes fill-heart {
            from { fill: transparent; }
            to { fill: #ff79c6; }
        }
        @keyframes show-star { to { opacity: 1; } }
        @keyframes draw-line { to { stroke-dashoffset: 0; } }
        #final-heart-modal.animate #final-heart-path {
            animation: draw-line 3s 0.5s ease-out forwards, 
                         fill-heart 1.5s 3.5s ease-in forwards;
        }
        #final-heart-modal.animate #final-heart-text {
            animation: show-star 2s 5s forwards;
        }
        
        /* ---- Media Queries para adaptar a escritorio ---- */
        @media (min-width: 768px) {
            #love-letter-text { font-size: 1.1rem; line-height: 1.7rem; }
            .envelope-wrapper { transform: scale(1); }
            .envelope { width: 340px; height: 220px; }
            .paper-sheet { padding: 40px 50px; }
            .declaration { margin-top: 40px; }
        }
    </style>
</head>
<body>
    <!-- Contenedores para el fondo nuevo -->
    <div id="star-background"></div>
    <div id="aurora-background">
        <div class="aurora"></div><div class="aurora"></div><div class="aurora"></div>
    </div>

    <div id="preloader">
        <h1 id="welcome-message" class="dancing-script"></h1>
        <div class="heart-loader" style="display: none;"></div>
    </div>

    <audio id="background-music" loop>
        <source src="musica/musica.mp3" type="audio/mpeg">
    </audio>
    <div id="confetti-container"></div>
    <div id="click-particles"></div>
    
    <main class="main-container">
        <div id="envelopeWrapper" class="envelope-wrapper">
            <div class="envelope">
                <div class="flap">
                    <div class="wax-seal">
                        <svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path></svg>
                    </div>
                </div>
                <div class="envelope-back"></div>
            </div>
            <p class="text-center mt-4 text-gray-300 font-semibold text-xl md:text-2xl dancing-script">Una sorpresa para ti...</p>
        </div>
    </main>

    <div id="fullPageLetter" class="full-page-letter">
        <div class="paper-sheet">
            <div id="hearts-container"></div>
            <h1 class="dancing-script text-4xl md:text-6xl text-purple-600 mb-4">
                ¡Feliz 1 año y 4 meses, Mi Amor!
            </h1>
            <div id="love-letter-text" class="text-left leading-relaxed">
                <p class="mb-4">Hoy, 23 de Junio, es un día muy especial para mí y para ti porque cumplimos 16 meses juntos, mi amor bella, No puedo creer que ya hayan pasado 16 meses desde que te pedí ser mi novia en esa cita tan especial que tuvimos en sendero, después de haber ido a comer pollito KFC, Recuerdo ese momento como si hubiera sido ayer mi vida Como cuando te vi por primera vez tu te veías tan bonita y yo tan feliz de verte.</p>
                <p class="mb-4">Amorcitoooo corazón y lo vuelvo a decir hoy pero hoy este día cumplimos 16 meses, y si no lo sabes lo feliz que estoy y me siento, porque estoy con una persona tan maravillosa y única como tu mi niña, Sabes mi amor me alegra haberte conocido, fuiste mi mejor casualidad, soy tan afortunado de tenerte en mi vida, no es mentira, es en serio, me encanta que estés en mi vida, has sido mi compañera en este viaje llamado vida, y juntos hemos superado obstáculos y diferencias hemos tenido problemas, Pero a pesar de todo, aquí estamos, más fuertes que nunca a pesar de nuestras peleas y indiferencia, Me gustas tal y Como la primera vez , te amoooo muchísimo, amo todo de ti tus ojos, tus labios, tu cabello, tu aroma, tus abrazos, tus besos, tu risa y tu alegría todo de ti amo aunque pienses que no me encantas mucho y demasiado mi vida Simplemente amo todo de ti, para mí eres perfecta mi corazoncito te adoro bastante sabes me siento feliz y orgulloso de estar contigo de ver cada uno de tus virtudes y ver lo capaz que eres de hacer las cosas lo que logras y te esfuerzas valoro mucho cada momento a tu lado y lo que haces me siento afortunado contigo.</p>
                <p class="mb-4">Y sabes que me gusta más de esto, es que sigo estando tan enamorado de ti como la primera vez que te vi tal y Como te lo dije, Mi amor por ti no ha disminuido, sino que ha crecido cada día más. Te amo hoy y siempre, mi amor.
Hoy día en este pasémoslo espectacular amándonos como siempre y sigamos cumpliendo más meses, años y los que tengan por venir, No te pienso soltar, tampoco lo hagas tú, Eres la razón por la que me levanto cada mañana, eres mi motivación, mi inspiración eres lo que eres un ser hecho para estar conmigo y yo contigo.</p>
                <p class="mb-4">Te amo, te amo, te amo No tengo palabras para expresar lo mucho que te amo. Eres mi todo Te amo más que ayer y nunca menos que mañana.</p>
                <p class="mb-4 font-bold">FELIZ 16 MESVERSARIO MI AMOR, TE AMOOOOOOO. Siempre te amaré.</p>
            </div>
            
            <div id="declarationSection" class="declaration">
                <p class="text-xl md:text-3xl font-semibold text-purple-700 mb-4">
                    ¿Quieres seguir estando conmigo más tiempo, mi vida?
                </p>
                <div class="buttons">
                    <button id="yesBtn" class="btn btn-yes">Sí, mil veces sí</button>
                    <button id="noBtn" class="btn btn-no">Nop</button>
                </div>
            </div>

            <div id="finalContent" class="hidden">
                 <h2 id="finalMessage" class="dancing-script text-3xl md:text-4xl text-purple-600 mt-6">¡Para siempre contigo y Feliz de un día más! Te amo.</h2>
                 
                 <!-- Carousel 3D -->
                 <div id="photoCarousel">
                    <h3 class="text-xl md:text-2xl text-purple-600 mb-4 mt-6 dancing-script">Nuestros Fotitos Juntos</h3>
                    <div class="carousel-wrapper-3d">
                        <div class="carousel-container-3d">
                            <div class="carousel-slide-3d"><img src="imagenes/img1.jpg" alt="Recuerdo 1" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2a003a/ffffff?text=Imagen+1';"></div>
                            <div class="carousel-slide-3d"><img src="imagenes/img4.JPG" alt="Recuerdo 2" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2a003a/ffffff?text=Imagen+2';"></div>
                            <div class="carousel-slide-3d"><img src="imagenes/img2.JPG" alt="Recuerdo 3" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2a003a/ffffff?text=Imagen+3';"></div>
                            <div class="carousel-slide-3d"><img src="imagenes/img3.JPG" alt="Recuerdo 4" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2a003a/ffffff?text=Imagen+4';"></div>
                        </div>
                    </div>
                    <div class="carousel-nav-3d">
                        <button id="prevBtn3d">&lt;</button>
                        <button id="nextBtn3d">&gt;</button>
                    </div>
                 </div>

                 <h2 id="concludingMessage" class="dancing-script text-2xl md:text-3xl text-purple-500 mt-8">Gracias por cada momento.</h2>

                 <!-- Interactive Star Map -->
                <div class="interactive-starmap-card">
                    <h3 class="text-xl md:text-2xl text-purple-400 mb-2 dancing-script">Un Universo de Razones</h3>
                    <div class="starmap-container">
                        <canvas class="starmap-canvas"></canvas>
                    </div>
                    <p class="starmap-message">Toca las estrellas</p>
                </div>

                <!-- Final Secret Star -->
                <div id="secret-star-card">
                    <div id="secret-star-container">
                        <div id="secret-star"></div>
                        <span>Una última sorpresa Vez</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="final-heart-modal">
        <svg id="final-heart-svg" viewBox="0 0 24 24">
            <path id="final-heart-path" d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path>
        </svg>
        <p id="final-heart-text" class="dancing-script">TE AMO MÁS QUE AYER PERO NUNCA MENOS QUE MAÑANA</p>
    </div>

    <button id="mute-btn"></button>
    <div id="bouquet">
        <div class="flower-wrap" id="flower1"><div class="stem"></div><div class="flower-head"><div class="petal" style="--r: -30deg; --d: 0.1s;"></div><div class="petal" style="--r: 0deg; --d: 0s;"></div><div class="petal" style="--r: 30deg; --d: 0.1s;"></div><div class="petal" style="--r: 60deg; --d: 0.2s;"></div><div class="petal" style="--r: -60deg; --d: 0.2s;"></div><div class="flower-center"></div></div></div>
        <div class="flower-wrap" id="flower2"><div class="stem"></div><div class="flower-head"><div class="petal" style="--r: -30deg; --d: 0.3s;"></div><div class="petal" style="--r: 0deg; --d: 0.2s;"></div><div class="petal" style="--r: 30deg; --d: 0.3s;"></div><div class="petal" style="--r: 60deg; --d: 0.4s;"></div><div class="petal" style="--r: -60deg; --d: 0.4s;"></div><div class="flower-center"></div></div></div>
        <div class="flower-wrap" id="flower3"><div class="stem"></div><div class="flower-head"><div class="petal" style="--r: -30deg; --d: 0.2s;"></div><div class="petal" style="--r: 0deg; --d: 0.1s;"></div><div class="petal" style="--r: 30deg; --d: 0.2s;"></div><div class="petal" style="--r: 60deg; --d: 0.3s;"></div><div class="petal" style="--r: -60deg; --d: 0.3s;"></div><div class="flower-center"></div></div></div>
    </div>

    <script>
        // DOM Elements
        const body = document.body;
        const yesBtn = document.getElementById('yesBtn');
        const noBtn = document.getElementById('noBtn');
        const declarationSection = document.getElementById('declarationSection');
        const finalContent = document.getElementById('finalContent');
        const bouquet = document.getElementById('bouquet');
        const music = document.getElementById('background-music');
        const preloader = document.getElementById('preloader');
        const muteBtn = document.getElementById('mute-btn');
        const waxSeal = document.querySelector('.wax-seal');
        const finalHeartModal = document.getElementById('final-heart-modal');

        // Speaker Icons
        const speakerOnIcon = `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>`;
        const speakerOffIcon = `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-4-4m0 4l4-4"></path></svg>`;

        function createStars() {
            const container = document.getElementById('star-background');
            if (!container) return;
            const starCount = 200;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() * 2.5 + 0.5;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDuration = `${Math.random() * 3 + 2}s`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(star);
            }
            const shootingStar = document.createElement('div');
            shootingStar.classList.add('shooting-star');
            shootingStar.style.top = `${Math.random() * 60}%`;
            shootingStar.style.left = `calc(-20% + ${Math.random() * 40}%)`;
            shootingStar.style.animationDelay = `${Math.random() * 5 + 2}s`;
            container.appendChild(shootingStar);
        }

        window.addEventListener('load', () => {
            createStars();
            const welcomeMessage = document.getElementById('welcome-message');
            const heartLoader = document.querySelector('.heart-loader');
            const hour = new Date().getHours();
            
            let greeting = "Buenas noches";
            if (hour >= 5 && hour < 12) { greeting = "Buenos días"; }
            else if (hour >= 12 && hour < 20) { greeting = "Buenas tardes"; }
            
            welcomeMessage.textContent = greeting;
            welcomeMessage.classList.add('visible');

            setTimeout(() => {
                welcomeMessage.style.opacity = '0';
                setTimeout(() => {
                    heartLoader.style.display = 'block';
                    setTimeout(() => {
                        if(preloader) {
                            preloader.style.opacity = '0';
                            setTimeout(() => {
                                preloader.style.display = 'none';
                                document.getElementById('envelopeWrapper').classList.add('loaded');
                            }, 800);
                        }
                    }, 2000);
                }, 1000);
            }, 2500);
        });
        
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const songUrl = urlParams.get('song');
            if (songUrl) { music.querySelector('source').src = decodeURIComponent(songUrl); music.load(); }
        } catch(e) { console.error("Error processing song URL:", e); }

        muteBtn.innerHTML = speakerOnIcon;
        muteBtn.addEventListener('click', () => {
            music.muted = !music.muted;
            muteBtn.innerHTML = music.muted ? speakerOffIcon : speakerOnIcon;
        });
        
        function revealLetterText() {
            const paragraphs = document.querySelectorAll('#love-letter-text p');
            paragraphs.forEach((p, index) => {
                p.style.animationDelay = `${index * 1.2}s`;
                p.classList.add('reveal-text');
            });
        }

        waxSeal.addEventListener('click', (e) => {
            createClickParticles(e.clientX, e.clientY);
            const synth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            }).toDestination();
            synth.triggerAttackRelease("C5", "8n", Tone.now());
            synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.2);
            synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.4);

            body.classList.add('open');
            waxSeal.style.pointerEvents = 'none';
            muteBtn.classList.add('visible');
            music.play().catch(error => console.log("Autoplay was blocked."));
            setInterval(createHeart, 500);
            setTimeout(revealLetterText, 2500);
        });

        yesBtn.addEventListener('click', () => {
            celebrate();
            declarationSection.style.display = 'none';
            finalContent.classList.remove('hidden');
            bouquet.classList.add('show');
            finalContent.querySelector('#finalMessage').style.opacity = '1';
            finalContent.querySelector('#photoCarousel').style.opacity = '1';
            finalContent.querySelector('.interactive-starmap-card').style.opacity = '1';
            init3DCarousel();
            initStarMap();
            document.getElementById('secret-star-card').addEventListener('click', showFinalHeart);
            
            setTimeout(() => { bouquet.classList.remove('show'); bouquet.classList.add('hide'); }, 5000);
            setTimeout(() => { 
                finalContent.querySelector('#concludingMessage').style.opacity = '1';
            }, 5500);
        });
        
        noBtn.addEventListener('mouseover', moveButton);
        noBtn.addEventListener('click', moveButton);
        
        function moveButton(e) {
            const container = document.querySelector('.buttons');
            const containerRect = container.getBoundingClientRect();
            
            noBtn.style.position = 'absolute';
            noBtn.classList.add('evading');

            // Set a timeout to move the button after the shake animation
            setTimeout(() => {
                const btnRect = noBtn.getBoundingClientRect(); // Get new rect after it becomes absolute
                let newTop = Math.random() * (containerRect.height - btnRect.height);
                let newLeft = Math.random() * (containerRect.width - btnRect.width);
                noBtn.style.top = `${newTop}px`;
                noBtn.style.left = `${newLeft}px`;
            }, 100);

            // Remove the class after a short time
            setTimeout(() => {
                noBtn.classList.remove('evading');
            }, 400); 
        }

        function celebrate() {
            const confettiContainer = document.getElementById('confetti-container');
            const colors = ['#d8bfd8', '#c3aed6', '#8a2be2', '#ffd700', '#f0e68c'];
            for (let i = 0; i < 100; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.classList.add('confetti-piece');
                confettiPiece.style.left = `${Math.random() * 100}vw`;
                confettiPiece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confettiPiece.style.transform = `rotate(${Math.random() * 360}deg)`;
                confettiPiece.style.animationDelay = `${Math.random() * 0.5}s`;
                confettiContainer.appendChild(confettiPiece);
                setTimeout(() => { confettiPiece.remove(); }, 5000);
            }
        }

        function createClickParticles(x, y) {
            const container = document.getElementById('click-particles');
            const colors = ['#e0b0ff', '#c3aed6', '#fdfaff'];
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.classList.add('click-particle');
                const size = Math.floor(Math.random() * 5 + 2);
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.top = `${y}px`;
                particle.style.left = `${x}px`;
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 50 + 20;
                particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
                particle.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
                container.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }
        }
        
        function createHeart() {
            const heartsContainer = document.getElementById('hearts-container');
            if (!heartsContainer) return;
            const heart = document.createElement('div');
            heart.classList.add('heart');
            heart.style.left = `${Math.random() * 100}%`;
            heart.style.animationDuration = `${Math.random() * 3 + 5}s`;
            heartsContainer.appendChild(heart);
            setTimeout(() => { heart.remove(); }, 8000);
        }
        
        function createTrail(x, y) {
            const trail = document.createElement('div');
            trail.classList.add('cursor-trail');
            trail.style.left = x + 'px';
            trail.style.top = y + 'px';
            document.body.appendChild(trail);
            setTimeout(() => {
                trail.remove();
            }, 800);
        }
        window.addEventListener('mousemove', (e) => createTrail(e.pageX, e.pageY));
        window.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0) {
                createTrail(e.touches[0].pageX, e.touches[0].pageY);
            }
        });

        // ---- 3D Carousel Logic ----
        function init3DCarousel() {
            const carousel = document.querySelector('.carousel-container-3d');
            if(!carousel) return;
            const slides = document.querySelectorAll('.carousel-slide-3d');
            const prevBtn = document.getElementById('prevBtn3d');
            const nextBtn = document.getElementById('nextBtn3d');
            let slideCount = slides.length;
            if (slideCount === 0) return;
            let angle = 360 / slideCount;
            let currentAngle = 0;
            const tz = Math.round((carousel.offsetHeight / 2) / Math.tan(Math.PI / slideCount));

            slides.forEach((slide, i) => {
                slide.style.transform = `rotateY(${i * angle}deg) translateZ(${tz}px)`;
            });

            const rotateCarousel = () => {
                carousel.style.transform = `translateZ(-${tz}px) rotateY(${currentAngle}deg)`;
            }

            nextBtn.addEventListener('click', () => {
                currentAngle -= angle;
                rotateCarousel();
            });

            prevBtn.addEventListener('click', () => {
                currentAngle += angle;
                rotateCarousel();
            });
            
            rotateCarousel();
        }

        // ---- Star Map Logic V2 ----
        function initStarMap() {
            const card = document.querySelector('.interactive-starmap-card');
            if (!card) return;
            const canvas = card.querySelector('.starmap-canvas');
            const messageEl = card.querySelector('.starmap-message');
            const ctx = canvas.getContext('2d');

            let width, height;
            let animationFrameId;
            let backgroundStars = [];

            // Main stars with initials and other interactive stars
            const mainStars = [
                { id: 'C', x: 0.2, y: 0.3, size: 8, msg: null },
                { id: 'A', x: 0.8, y: 0.7, size: 8, msg: null },
                { x: 0.8, y: 0.25, size: 6, msg: "Eres fuerte" },
                { x: 0.5, y: 0.4, size: 5, msg: "Amo tu sonrisa" },
                { x: 0.2, y: 0.65, size: 7, msg: "Estoy feliz a tu lado" },
                { x: 0.85, y: 0.75, size: 6, msg: "Estoy orgulloso de ti" },
                { x: 0.45, y: 0.8, size: 5, msg: "Eres perfecta" },
                { x: 0.65, y: 0.1, size: 5, msg: "Eres única" }
            ];

            function createBackgroundStars(num) {
                backgroundStars = [];
                for (let i = 0; i < num; i++) {
                    backgroundStars.push({
                        x: Math.random(),
                        y: Math.random(),
                        size: Math.random() * 1.5 + 0.5,
                        opacity: Math.random() * 0.8 + 0.2,
                        twinkleSpeed: (Math.random() - 0.5) * 0.015
                    });
                }
            }

            function draw() {
                ctx.clearRect(0, 0, width, height);

                // Draw background stars
                backgroundStars.forEach(star => {
                    star.opacity += star.twinkleSpeed;
                    if (star.opacity > 1 || star.opacity < 0.2) {
                        star.twinkleSpeed *= -1;
                    }
                    ctx.beginPath();
                    ctx.arc(star.x * width, star.y * height, star.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.fill();
                });
                
                // Draw main constellation line
                const starC = mainStars.find(s => s.id === 'C');
                const starA = mainStars.find(s => s.id === 'A');
                if (starC && starA) {
                    ctx.beginPath();
                    ctx.moveTo(starC.x * width, starC.y * height);
                    ctx.lineTo(starA.x * width, starA.y * height);
                    ctx.strokeStyle = "rgba(255, 215, 0, 0.5)";
                    ctx.lineWidth = 1.5;
                    ctx.shadowColor = "rgba(255, 215, 0, 1)";
                    ctx.shadowBlur = 10;
                    ctx.stroke();
                    ctx.shadowBlur = 0; // Reset shadow
                }

                // Draw main interactive stars and initials
                mainStars.forEach(star => {
                    const pulse = Math.sin(Date.now() * 0.002) * 0.5 + 0.5;
                    const currentSize = star.size * (1 + pulse * 0.1);
                    
                    ctx.beginPath();
                    const gradient = ctx.createRadialGradient(star.x * width, star.y * height, 0, star.x * width, star.y * height, currentSize);
                    gradient.addColorStop(0, "rgba(255, 255, 255, 1)");
                    gradient.addColorStop(0.7, "rgba(255, 215, 0, 0.8)");
                    gradient.addColorStop(1, "rgba(255, 215, 0, 0)");
                    ctx.fillStyle = gradient;
                    ctx.arc(star.x * width, star.y * height, currentSize * 1.5, 0, Math.PI * 2);
                    ctx.fill();

                    if(star.id) {
                        ctx.font = `bold ${star.size * 2.5}px 'Dancing Script'`;
                        ctx.fillStyle = "#fff";
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = "#fff";
                        ctx.shadowBlur = 5;
                        ctx.fillText(star.id, star.x * width, star.y * height);
                        ctx.shadowBlur = 0;
                    }
                });
                
                animationFrameId = requestAnimationFrame(draw);
            }

            function resizeCanvas() {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                width = canvas.offsetWidth;
                height = canvas.offsetHeight;
                canvas.width = width;
                canvas.height = height;
                createBackgroundStars(100);
                draw();
            }
            
            function checkInteraction(x, y) {
                let hoveredStar = null;
                for (const star of mainStars) {
                    if (!star.msg) continue; // Skip initial stars for messages
                    const dist = Math.sqrt(Math.pow(x - star.x * width, 2) + Math.pow(y - star.y * height, 2));
                    if (dist < star.size + 10) { // Increased hit area
                        hoveredStar = star;
                        break;
                    }
                }
                
                if (hoveredStar) {
                    messageEl.textContent = hoveredStar.msg;
                    messageEl.style.opacity = 1;
                } else {
                    messageEl.textContent = "Toca las estrellas";
                    messageEl.style.opacity = 0.7;
                }
            }

            const interactionHandler = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                checkInteraction(x, y);
                if (e.touches) e.preventDefault();
            };

            canvas.addEventListener('mousemove', interactionHandler);
            canvas.addEventListener('touchmove', interactionHandler, { passive: false });
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        }

        // ---- Final Heart Modal Logic ----
        function showFinalHeart() {
            finalHeartModal.classList.add('visible');
            finalHeartModal.classList.remove('animate');
            void finalHeartModal.offsetWidth;
            finalHeartModal.classList.add('animate');
        }
        finalHeartModal.addEventListener('click', () => {
            finalHeartModal.classList.remove('visible', 'animate');
        });

    </script>
</body>
</html>
